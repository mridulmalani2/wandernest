// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum StudentStatus {
  PENDING_APPROVAL
  APPROVED
  SUSPENDED
}

enum RequestStatus {
  PENDING
  MATCHED
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum ReportType {
  SAFETY_CONCERN
  INAPPROPRIATE_BEHAVIOR
  PAYMENT_DISPUTE
  HARASSMENT
  NO_SHOW
  OTHER
}

// ============================================
// MODELS
// ============================================

model Student {
  id                String   @id @default(cuid())
  email             String   @unique
  googleId          String   @unique
  name              String
  gender            String   // male, female, prefer_not_to_say
  nationality       String
  institute         String
  idCardUrl         String?
  coverLetter       String   @db.Text
  languages         String[] // Array of language codes
  interests         String[] // Array of interest tags
  bio               String?  @db.Text
  status            StudentStatus @default(PENDING_APPROVAL)
  city              String
  priceRange        Json?    // {min: number, max: number}

  // Safety
  safetyGuidelinesAcknowledged Boolean @default(false)
  safetyAcknowledgedAt         DateTime?

  // Metrics
  tripsHosted       Int      @default(0)
  averageRating     Float?
  noShowCount       Int      @default(0)
  acceptanceRate    Float?
  reliabilityBadge  String?  // bronze, silver, gold

  availability      StudentAvailability[]
  requestSelections RequestSelection[]
  reviews           Review[]
  reports           Report[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([city])
  @@index([nationality])
  @@index([status])
  @@index([email])
}

model StudentAvailability {
  id          String   @id @default(cuid())
  studentId   String
  dayOfWeek   Int      // 0-6 (Sunday-Saturday)
  startTime   String   // "09:00"
  endTime     String   // "17:00"
  note        String?  // "Not available during exams"

  student     Student  @relation(fields: [studentId], references: [id])

  @@index([studentId])
}

model TouristRequest {
  id                String   @id @default(cuid())
  email             String
  emailVerified     Boolean  @default(false)
  verificationCode  String?

  // Trip Details
  city              String
  dates             Json     // {start: Date, end: Date} or single date
  preferredTime     String   // "morning", "afternoon", "evening"
  numberOfGuests    Int
  groupType         String   // family, friends, solo, business
  accessibilityNeeds String?

  // Matching Criteria
  preferredNationality String?
  preferredLanguages   String[]
  preferredGender      String?  // male, female, no_preference
  serviceType          String   // itinerary_help, guided_experience
  interests            String[]
  budget               Float?

  // Contact
  phone             String?
  whatsapp          String?
  contactMethod     String   // email, phone, whatsapp
  meetingPreference String   // hotel_pickup, public_place, virtual
  tripNotes         String?  @db.Text

  status            RequestStatus @default(PENDING)
  assignedStudentId String?

  selections        RequestSelection[]
  review            Review?

  createdAt         DateTime @default(now())
  expiresAt         DateTime

  @@index([city])
  @@index([status])
  @@index([email])
}

model RequestSelection {
  id                String         @id @default(cuid())
  requestId         String
  studentId         String
  status            String         // pending, accepted, rejected
  message           String?        @db.Text

  request           TouristRequest @relation(fields: [requestId], references: [id])
  student           Student        @relation(fields: [studentId], references: [id])

  createdAt         DateTime       @default(now())

  @@index([requestId])
  @@index([studentId])
}

model Review {
  id                String         @id @default(cuid())
  requestId         String         @unique
  studentId         String
  rating            Int            // 1-5
  comment           String?        @db.Text
  wasNoShow         Boolean        @default(false)

  request           TouristRequest @relation(fields: [requestId], references: [id])
  student           Student        @relation(fields: [studentId], references: [id])

  createdAt         DateTime       @default(now())

  @@index([studentId])
}

model Report {
  id                String     @id @default(cuid())
  type              ReportType
  reportedUserId    String     // ID of the user being reported (Student)
  reportedBy        String     // Email or ID of person making report
  description       String     @db.Text
  status            String     @default("pending") // pending, under_review, resolved, dismissed
  actionTaken       String?    @db.Text
  reviewedAt        DateTime?
  reviewedBy        String?    // Admin who reviewed

  student           Student    @relation(fields: [reportedUserId], references: [id])

  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([reportedUserId])
  @@index([status])
  @@index([type])
}
